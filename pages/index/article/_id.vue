<template>
  <div>
    <v-toolbar flat>
      <v-btn icon large class="d-flex d-md-none" to="/">
        <v-icon>mdi-home-outline</v-icon>
      </v-btn>
      <v-avatar
        v-if="
          titleSection.user &&
            titleSection.user.facebook &&
            article.articleType !== 'movieReviewCard'
        "
        size="40"
        class="mr-3"
      >
        <img
          :src="
            `https://graph.facebook.com/${titleSection.user.facebook.id}/picture?type=square`
          "
        />
      </v-avatar>
      <div v-if="article.articleType !== 'movieReviewCard'">
        <div
          class="py-0 title"
          :class="user && 'primary--text pointer'"
          @click="profileVisit"
        >
          {{
            (titleSection &&
              titleSection.user &&
              ((titleSection.user.facebook &&
                titleSection.user.facebook.displayName) ||
                titleSection.user.username)) ||
              'Please select a topic'
          }}
        </div>
        <div class="caption text--secondary">{{ titleSection.title }}</div>
      </div>
      <div v-if="article.articleType === 'movieReviewCard'" class="title">
        {{ article.movieReviewCard.Title }} -
        <span class="text--secondary">{{ article.movieReviewCard.Year }}</span>
      </div>
    </v-toolbar>
    <v-divider />
    <div
      id="articleContainer"
      :style="{
        'min-height': windowHeight - 66 - editorHeight + 'px',
        'max-height': windowHeight - 66 - editorHeight + 'px'
      }"
      class="overflowY-auto scrollBar"
    >
      <v-row v-if="article" class="mx-0">
        <v-col
          v-if="article.articleType === 'quoteCard'"
          md="8"
          cols="10"
          class="mr-auto"
        >
          <QuoteCard :cardcontent="article"> </QuoteCard>
        </v-col>
        <v-col
          v-if="article.articleType === 'movieReviewCard'"
          md="8"
          cols="10"
          class="mr-auto"
        >
          <MovieCard :cardcontent="article" />
        </v-col>
        <v-col
          v-if="article.articleType === 'fullDetailsCard'"
          md="8"
          cols="10"
          class="mr-auto"
        >
          <chat-card :cardcontent="article" showfullcard> </chat-card>
        </v-col>
      </v-row>
      <AllCommentList
        :user="user"
        :all-comments="allComments"
        :is-twitter-loaded="isTwitterLoaded"
        :comment-disable="commentDisable"
      />
    </div>
    <v-divider />
    <div class="editor-pos">
      <v-card flat class="br-0 px-3">
        <v-btn
          v-if="replyComment"
          class="right-menu pos-a"
          icon
          small
          @click="removeReply"
          ><v-icon small>mdi-close</v-icon>
        </v-btn>
        <ReplyCard v-if="replyComment" :replycontent="replyComment" />
        <resize-observer @notify="handleResize" />
        <!-- <CommentForm
          v-if="user && user.userDetails && isAllowed()"
          @formData="formUpdate"
          @onSubmit="onSubmit"
        /> -->
        <div v-if="user && user.userDetails && isAllowed()">
          <CommentFormMD @formData="formUpdate" @onSubmit="onSubmit" />
        </div>
        <v-row v-else-if="user">
          <v-col class="pa-0">
            <v-card-text color="accent" class="subtitle-1 text--disabled">
              <resize-observer @notify="handleResize" />
              Thank you for your contribution
              <div class="caption text--disabled">
                You can comment only once
              </div>
            </v-card-text>
          </v-col>
        </v-row>
        <v-row v-else>
          <v-col class="pa-0">
            <v-card-text color="accent" class="subtitle-1 text--disabled">
              <resize-observer @notify="handleResize" />
              Login to Comment
            </v-card-text>
          </v-col>
          <v-col cols="auto">
            <v-btn class="accent" type="button" @click="loginPopUp">
              Login
            </v-btn>
          </v-col>
        </v-row>
      </v-card>
    </div>
  </div>
</template>

<script>
import { mapGetters } from 'vuex'
import storyHeader from './headerData'
import { toBase64 } from '~/utilities/common'
import ChatCard from '~/components/ChatCard'
import AllCommentList from '~/components/AllCommentList'
import QuoteCard from '~/components/ChatCard/QuoteCard'
// import CommentForm from '~/components/CommentForm'
import ReplyCard from '~/components/ChatCard/ReplyCard'
import MovieCard from '~/components/ChatCard/MovieCard'
import CommentFormMD from '~/components/CommentFormMD'
// import LoadingSkeleton from '~/components/LoadingSkeleton'

export default {
  components: {
    'chat-card': ChatCard,
    QuoteCard,
    // CommentForm,
    AllCommentList,
    ReplyCard,
    MovieCard,
    CommentFormMD
    // LoadingSkeleton
  },
  async fetch({ store, params, route, redirect }) {
    try {
      await store.dispatch('article/getSingleArticle', route.params.id)
      await store.dispatch('article/getComments', {
        articleId: route.params.id
      })
    } catch (err) {
      redirect('/')
    }
  },
  data() {
    return {
      autoRight: true,
      editorHeight: 0,
      comment: '',
      formdata: null,
      isTwitterLoaded: false,
      commentDisable: false
    }
  },
  computed: {
    ...mapGetters({
      windowHeight: 'commonState/windowHeight',
      article: 'article/singleArticle',
      allComments: 'article/allComments',
      user: 'user',
      titleSection: 'article/titleSection',
      replyComment: 'commonState/replyComment',
      contentLoading: 'article/contentLoading'
    })
  },
  watch: {
    article(newValue) {
      if (!newValue) {
        this.$router.replace({ path: '/' })
      }
    }
  },
  mounted() {
    this.$meta().refresh()
  },
  methods: {
    handleResize({ height }) {
      this.editorHeight = height
    },
    isAllowed() {
      if (this.user.userDetails.role === 'admin') return true
      if (
        this.article.author._id === this.user.userDetails._id &&
        this.article.articleType !== 'movieReviewCard'
      )
        return true
      const filterComment = this.allComments.filter((comment) => {
        return (
          comment.commentor === this.user.userDetails._id ||
          comment.commentor._id === this.user.userDetails._id
        )
      })

      if (filterComment.length >= 1) {
        this.commentDisable = true
        return false
      } else {
        this.commentDisable = false
        return true
      }
    },
    async formUpdate(data) {
      this.formdata = {
        ...data,
        file: data && data.file ? await toBase64(data.file) : null
      }
    },
    loginPopUp() {
      this.$store.dispatch('commonState/loginPopUp')
    },
    async onSubmit() {
      if (this.replyComment) {
        this.formdata.replyComment = this.replyComment._id
      }
      const sendForm = { ...this.formdata, articleId: this.$route.params.id }
      await this.$store.dispatch('article/postComment', sendForm)
      const container = this.$el.querySelector('#articleContainer')
      container.scrollTop = container.scrollHeight
    },
    removeReply() {
      this.$store.dispatch('commonState/replyComment', null)
    },
    profileVisit() {
      if (this.user && this.user.userDetails) {
        this.$router.push(
          `/profile/${this.titleSection &&
            this.titleSection.user &&
            this.titleSection.user._id}`
        )
      }
    }
  },
  head() {
    return {
      ...storyHeader(this.article),
      script: [
        {
          src: '//platform.twitter.com/widgets.js',
          async: true,
          defer: true,
          callback: () => {
            this.isTwitterLoaded = true
          }
        }
      ]
    }
  },
  beforeRouteLeave(to, from, next) {
    this.$store.dispatch('commonState/replyComment', null)
    this.formdata = null
    next()
  }
}
</script>

<style scoped>
.pos-r {
  position: relative;
}
.pos-a {
  position: absolute;
}
.pointer {
  cursor: pointer;
}
.right-menu {
  right: 0;
  top: 0;
  z-index: 1;
}
.overflowY-auto {
  overflow-y: auto;
}
.border-right-grey {
  border-right: 1px solid var(--v-greyAccent-base);
}
.editor-pos {
  position: relative;
  bottom: 0;
  background: white;
  width: 100%;
}
.middle-col {
  position: relative;
}
.br-0 {
  border-radius: 0 !important;
}
</style>
